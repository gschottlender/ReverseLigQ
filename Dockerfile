# -------------------------------------------------------------------
# BASE IMAGE
# -------------------------------------------------------------------
FROM continuumio/miniconda3:latest

# -------------------------------------------------------------------
# WORKDIR
# -------------------------------------------------------------------
WORKDIR /app

# -------------------------------------------------------------------
# COPY ENVIRONMENT
# -------------------------------------------------------------------
COPY environment.yml .

# -------------------------------------------------------------------
# CREATE CONDA ENVIRONMENT
# -------------------------------------------------------------------
RUN conda env create -n reverse_ligq -f environment.yml && \
    conda clean -afy && \
    rm -rf /opt/conda/pkgs

# -------------------------------------------------------------------
# ACTIVATE ENVIRONMENT
# -------------------------------------------------------------------
ENV PATH="/opt/conda/envs/reverse_ligq/bin:${PATH}"

# -------------------------------------------------------------------
# HUGGING FACE CACHE DIRECTORY
# Create a writable directory for Hugging Face / transformers cache.
# We give it 777 permissions so it works even when the container is
# run as a non-root user (e.g. with `-u $(id -u):$(id -g)`).
# -------------------------------------------------------------------
RUN mkdir -p /hf_cache && chmod 777 /hf_cache

# Set default cache locations for Hugging Face and transformers.
ENV HF_HOME=/hf_cache

# -------------------------------------------------------------------
# COPY SOURCE CODE
# -------------------------------------------------------------------
COPY . .

# -------------------------------------------------------------------
# ENTRYPOINT
# -------------------------------------------------------------------
ENTRYPOINT ["python", "rev_ligq.py"]

# -------------------------------------------------------------------
# DEFAULT CMD
# -------------------------------------------------------------------
CMD ["--help"]
